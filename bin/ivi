#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * Robust Composer autoloader discovery
 * - Local project:   <project>/vendor/autoload.php
 * - Package vendor:  ~/.config/composer/vendor/autoload.php  (Composer v2)
 * - Legacy vendor:   ~/.composer/vendor/autoload.php          (Composer v1)
 * - Fallback:        ../../autoload.php (in case of vendor/bin symlink)
 */
$autoloadCandidates = [
    __DIR__ . '/../vendor/autoload.php',                     // package-local (create-project)
    dirname(__DIR__, 2) . '/vendor/autoload.php',            // vendor/bin/ivi -> ../../vendor/autoload.php
    getenv('COMPOSER_HOME') ? rtrim(getenv('COMPOSER_HOME'), '/') . '/vendor/autoload.php' : null, // composer v2
    $_SERVER['HOME'] ? rtrim($_SERVER['HOME'], '/') . '/.config/composer/vendor/autoload.php' : null, // composer v2 default
    $_SERVER['HOME'] ? rtrim($_SERVER['HOME'], '/') . '/.composer/vendor/autoload.php' : null, // composer v1 default
];
$autoload = null;
foreach ($autoloadCandidates as $c) {
    if ($c && is_file($c)) {
        $autoload = $c;
        break;
    }
}
if (!$autoload) {
    fwrite(STDERR, "[ERROR] Could not locate Composer autoload.php\n");
    exit(1);
}
require $autoload;

use Ivi\Core\Console\CommandRunner;

final class CliBootstrap
{
    private static function badge(string $label, string $color): string
    {
        $colors = [
            'red'    => "\033[1;31m",
            'green'  => "\033[1;32m",
            'yellow' => "\033[1;33m",
            'blue'   => "\033[1;34m",
            'cyan'   => "\033[1;36m",
            'gray'   => "\033[0;37m",
            'reset'  => "\033[0m",
        ];
        $start = $colors[$color] ?? $colors['reset'];
        $end   = $colors['reset'];
        return sprintf("[%s%s%s]", $start, strtoupper($label), $end);
    }

    public static function run(array $argv): void
    {
        $cmd = $argv[1] ?? null;

        // ivi new <name>
        if ($cmd === 'new') {
            $name = $argv[2] ?? null;
            if (!$name) {
                echo self::badge('ERROR', 'red') . " Missing project name.\n";
                echo self::badge('INFO', 'yellow') . " Usage: ivi new <project-name>\n";
                exit(1);
            }

            echo self::badge('IVI', 'cyan') . " Creating new project: {$name}\n";
            $cmdLine = sprintf('composer create-project iviphp/ivi %s', escapeshellarg($name));
            passthru($cmdLine, $code);

            if ($code === 0) {
                echo self::badge('DONE', 'green') . " Project '{$name}' created!\n";
                echo self::badge('TIP', 'yellow') . " Next:\n  cd {$name}\n  composer serve\n";
            } else {
                echo self::badge('ERROR', 'red') . " Creation failed (code {$code}).\n";
            }
            exit($code);
        }

        // fallback: commands internes
        (new CommandRunner())->run($argv);
    }
}

CliBootstrap::run($argv);
